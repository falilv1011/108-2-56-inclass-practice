---
title: "2020-3-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## packages

安裝package
```{r}
install.packages(c("dplyr", "lubridate"))

```

```{r}
library(googlesheets4)
library(dplyr)
library(lubridate)
```

## Create object

```{r}
a <- 2
a = 2 # = 與 <-同義
```

```{r}
a
```

## variable

```{r}
my_108_total_credits <- 15
_108_total_credits <- 15
108_total_credits <- 15
_my_108_total_credits <- 15
my.108.total_credits <- 15
.108.total_credits <- 15 # 隱藏變數
.my.108.total_credits <- 15
我的108學年總學分數 <- 15
`我的108學年總學分數` <- 15 # 特殊名稱處理，`不是名稱的一部份
`.108.total_credits` <- 15
```

```{r}
`我的年紀` <- 20
my_age <- `我的年紀`
```

## Atomic vecter

```{r}
num1 <- 5
vNum1 <- c(2,5)
vNum2 <- c(2, num1)
```

Vecter stacking
```{r}
vNum1 <- c(-1,5)
vNum2 <- c(2,3)
vNum4 <- c() # 空向量
```

```{r}
vNum3 <- c(vNum2, vNum1)
vNum4 <- c(vNum4, vNum1) # 向量疊代 （recursive vector concatenate）
```

### Different types
```{r}
num1<-5 # 非整數
num2<-5L # 整數

num1Vector<-c(5,6,7)
num2Vector<-c(5L,6L,7L)
```

### Character
```{r}
char1<-"你好"
char2<-'你好'
```

使用class()查詢上述物件類別。
```{r}
class(char2)
```

查詢函數用法：

Script window: 游標放在函數名稱任何一個位置，按F1。
Console window: ?函數名稱 按enter。
右下角Help tab的放大鏡打函數名稱。


他說:"今天多了一個確診。"

```{r}
HeSaid<-'他說:"今天多了一個確診。"' #裡面有"外面要用' # run了之後\\稱為escape
```


```{r}
library(httr)
library(dplyr)
GET("https://api.github.com/repos/tpemartin/108-2-56-inclass-practice/commits") %>%
  content() %>%
  View()   #游標放在函數名稱任何一個位置，按F1，可查詢函數
```

```{r}
library(googlesheets4)
`出席狀況表單網址` <- "https://docs.google.com/spreadsheets/d/1EAG49qDKPWWi0ebkVr29TLrvVnoBPfkvxYY-J3xLAHY/edit#gid=458686645" # 缺乏定義值
ss <- as_sheets_id(`出席狀況表單網址`)
homework_sheet <- sheets_read(ss,sheet=1)
```


Logical
邏輯：
為「真」： T或TRUE (要全大寫)。
為「否」： F或FALSE (要全大寫)。
```{r}
logi1 <- c(T,TRUE,F,FALSE,FALSE)
```

邏輯值遇到數學運算時T會被當成1，而F會被當成0
```{r}
# 加總向量內的所有元素值。
sum(logi1)
```


typeof()
顯示atomic vector元素的基本認定型態，它代表電腦記憶體在儲存時真正看待的型態。
```{r}
num <- c(1.5, 2, 3)
int <- c(1L, 3L, -2L)
char <- c("1.5","2","3")
logi <- c(T,T,F)

typeof(num)
typeof(int)
typeof(char)
typeof(logi)
```

class()
依資料的螢幕顯示型態及能對它進行的操作所做的分類。
```{r}
class(num)
class(int)
class(char)
class(logi)
```


## Atomic Vector Extended

###factor: 類別資料
```{r}
factor(
  字串向量
)
```

```{r}
# 10位學生的主系
majors10_char <- c('經濟學系','社會學系','社會學系','經濟學系','經濟學系','社會學系','經濟學系','經濟學系','經濟學系','社會學系')

typeof(majors10_char)
class(majors10_char)
```


```{r}
majors10_factor <- factor(majors10_char)
# 或
majors10_factor <- factor(
  c('經濟學系','社會學系','社會學系','經濟學系','經濟學系','社會學系','經濟學系','經濟學系','經濟學系','社會學系')
)

typeof(majors10_factor)
class(majors10_factor)
```

majors10_char及majors10_factor的螢幕顯示型態是不同的：
```{r}
majors10_char
```

```{r}
majors10_factor
```

as.integer()將資料的class轉成integer。由於factor被轉成integer後，其螢幕顯示會顯示電腦是用什麼數字在存這些類別資料。
```{r}
as.integer(majors10_factor) 
```

數字與類別文字的對照表mapping table:
```{r}
levels(majors10_factor)
```
levels() 顯示的類別名稱(categorical values) 順序整數值是R真正儲存的內容 例如說在這邊 社會學系會存成1 而經濟學系會存成2

### Date/Time

POSIXct/POSIXt: 時間資料
```{r}
ymd_hms(
  字串向量
)
```

台北
2020-03-18 13:52:40

時間輸入方式: ymd_hms
時間來自時區: Asia/Taipei

```{r}
tpeTime <- ymd_hms("2020-03-18 13:52:40",
        tz="Asia/Taipei")
```

我們使用lubridate中的ymd_hms函數有以下兩種做法：
作法一：使用library()
```{r}
library(lubridate)
tpeTime <- ymd_hms("2020-03-18 13:52:40",
        tz="Asia/Taipei")
```
作法二：不使用library()
```{r}
tpeTime <- lubridate::ymd_hms("2020-03-18 13:52:40",
        tz="Asia/Taipei")
```

葡萄牙
Mar.18, 2020, 05:52:40

時間輸入方式: mdy_hms
時間來自時區: Europe/Lisbon

```{r}
pgTime <- mdy_hms("Mar.18, 2020, 05:52:40",
                  tz="Europe/Lisbon")
```


來自相同時區、相同輸入方式的時間文字字串，可以直接套入相同函數轉成Date/Time類別。
```{r}
tpeTime <- c("2020-03-18 13:52:40",
             "2020-03-11 03:12:40")
tpeTime <- 
  ymd_hms(
    tpeTime, # 呼叫tpeTime向量值
    tz="Asia/Taipei"
    )
```
相當於
```{r}
tpeTime <- 
  ymd_hms(
    c("2020-03-18 13:52:40","2020-03-11 03:12:40"),
    tz="Asia/Taipei"
    )
```


若時間字串來自UTC，那可以不設定tz參數，即
```{r}
ymd_hms(
c("2020-03-18 13:52:40","2020-03-11 03:12:40")
)
```

若時間字串長得像“2020-03-11T06:56:17Z”，它來自UTC時區：
```{r}
ymd_hms("2020-03-11T06:56:17Z")
```


以某個時區顯示

以UTC表示
```{r}
with_tz(tpeTime, tzone="UTC")
with_tz(pgTime, tzone="UTC")
```

以Europe/Paris表示
```{r}
with_tz(tpeTime, tzone="Europe/Paris")
with_tz(pgTime, tzone="Europe/Paris")
```


小心以下兩函數的input中一個是tz，一個是tzone
```{r}
ymd_hms(..., tz="Asia/Taipei")
with_tz(..., tzone="Asia/Taipei")
```


type
```{r}
class(tpeTime)
typeof(tpeTime)

as.numeric(tpeTime)
as.numeric(pgTime)
```
Date/Time的儲存其實是數值，它的原點是UTC時區的1970-01-01 00:00:00。 as.numeric(tpeTime)的值顯示tpeTime離那個原點已過了多少秒。



## List
```{r}
vecterExample <- c(2, 6, 7)
listExample <- list(2, 6, 7)

print(vecterExample)
print(listExample)
```

每個元素值可以是不同type的物件值
```{r}
# 用vecter儲存
c("2020-03-31T13:40:55Z",
  "一芳",
  "2",
  "水果茶")

# 用list儲存

`小明交易1` <- list(   #小明交易是特殊物件要用反頓點`
 lubridate::ymd_hms("2020-03-31T13:40:55Z"), # Date/Time class
  "一芳", # character
  2, # numeric
  "水果茶" # character
)
print(`小明交易1`)
```

物件值可以是vector形式，也可以list
```{r}
# 用vecter
c(
  c("108學年第1學期", "高級會計學", "高等統計學"),  #向量1
  c("108學年第2學期", "食在拉丁美洲")  #向量2
)
```

```{r}
# 用list
list( 
  c("108學年第1學期", "高級會計學", "高等統計學"),  #向量1
  c("108學年第2學期", "食在拉丁美洲")  #向量2
  )
```


```{r}
# list含兩個vectors
`小明108學年課表A` <- list(
  c("108-1","高級會計學","高等統計學"),
  c("108-2","食在拉丁美洲")
)
print(`小明108學年課表A`)
```


```{r}
# list含兩個lists
`小明108學年課表B` <- list(
  list("108-1","高級會計學","高等統計學"),
  list("108-2","食在拉丁美洲")
)
print(`小明108學年課表B`)
str(`小明108學年課表B`)
```

```{r}
# list含兩個lists, 子層list又各含兩個vectors
`小明108學年課表C` <- list(
  list(
    c("108-1"), # 可只寫 "108-1"
    c("高級會計學","高等統計學")
       ),
  list(
    c("108-2"),
    c("食在拉丁美洲")
  )
)
print(`小明108學年課表C`)
```

物件值可以取名
```{r}
# list含兩個lists, 子層list又各含兩個vectors
`小明108學年課表C` <- list(          
 `上學期`=list(            
    `108學年第1學期`=c("108-1"), # 可只寫 "108-1"  # 將108學年第一學期的lists取名108學年第1學期
    courses=c("高級會計學","高等統計學")           # 取名稱時=把它想成<-，名稱在<-左邊
       ),
  `下學期`=list(            
    `108學年第2學期`=c("108-2"),                   # 將108學年第二學期的lists取名108學年第2學期
    courses=c("食在拉丁美洲")                      # 將課程的list取名courses
  )                                                # run了之後遇到取名會用$表示
)
print(`小明108學年課表C`)
```

## Github Commit

記得「list可將好幾個物件，不管它是什麼type都可放在一起」，可將date用Date/Time class存起來。
```{r}
commit <- list(
  author=list(                         
    name="Martin老師",                   # 物件值可以取名
    email="mtlin@gm.ntpu.edu.tw", 
    time=ymd_hms("2020-03-25T07:17:40Z")
    ),                                   # author和committer用list比較好，因為有時間要用date/time class
  committer=list(
    name="emilyluckey", 
    email="emily007@gmail.com",
    time=ymd_hms("2020-03-26T08:18:40Z")
    ),
  message="update"                       # 用C或List都可以 # c括號寫不寫都可，因為只是一個簡單的字update
)
print(commit)
```


這種回傳資訊格式叫做JSON(JavaScript Object Notation), 每個程式語法都會準備一個物件形式用來儲存接收到的JSON資料；R會用list type，Python會用dictionary type。

也因為每個程式都可接收JSON形式資料，不同程式開發者若有必要進行網路資訊交換時會將複雜資料結構轉成JSON再交換出去。

我們的程式要在網路送出commit資訊時，可以透過以下程序將list轉成JSON：
```{r}
library(jsonlite) # 不少同學這行會有Error，還記得如何排除嗎？
toJSON(commit)
```

學生小明，在108學年第1學期修了Alice老師所授的個體經濟學（得分85分）、Mark老師所授的總體經濟學(得分73分)。在108學年第2學期修了Jason老師所授的作業研究（得分90分）。

使用list你會怎麼記錄上面的資訊。
第一種:
```{r}
# 108-1 
course1_1081 <- 
  list(
    name="個體經濟學",
    teacher="Alice",
    grade=85
  )
course2_1081 <-
  list(
    name="總體經濟學",
    teacher="Mark",
    grade=78
  )
`108-1修課記錄` <- 
  list(
    course1_1081,
    course2_1081
  )

# 108-2
course1_1082 <- 
  list(
    name="作業研究",
    teacher="Jason",
    grade=90
  )
`108-2修課記錄` <- 
  list(
    course1_1082
  )

# 整合兩學期
`每學期修課記錄` <- list(
  `108-1`=`108-1修課記錄`,
  `108-2`=`108-2修課記錄`
)

# 完成記錄
`小明的修課記錄` <- 
  list(
    name="小明",
    semesters=`每學期修課記錄`
  )
```
第二種:
```{r}
`小明的修課記錄` <- 
  list(
    name="小明",
    semesters=
      list(
        `108-1`=
          list(
            year=108,
            semester=1,
            courses=
              list(
                list(
                  name="個體經濟學",
                  teacher="Alice",
                  grade=85
                ),
                list(
                  name="總體經濟學",
                  teacher="Mark",
                  grade=78
                )
              )
            ),
        `108-2`=
          list(
            year=108,
            semester=2,
            courses=
              list(
                list(
                  name="作業研究",
                  teacher="Jason",
                  grade=90
                )
              )
            )
      ) 
    )
```

今（“2020-03-31”）明（“2020-04-01”）「台北市」氣溫最高25度，最低18度；「新北市」氣溫最高24度，最低15度。
```{r}
`天氣預報` <-list(
  `台北市` = list(
    date = c(
      today = "2020-03-31", 
      tomorrow = "2020-04-01"
    ), 
    highest = 25, 
    lowest = 18
  ), 
  `新北市` = list(
    date = c(
      today = "2020-03-31", 
      tomorrow = "2020-04-01"
    ), 
    highest = 24, 
    lowest = 15
  )
)
print(`天氣預報`)
```


## 物件儲存

```{r}
save(commit,listExample,`小明108學年課表C`, file="today.Rda")
```

```{r}
load("today.Rda")
```


## 選取元素

### 選「一個元素」

#### 用位置選`[[.]]`

```{r}
vectorExample <- c("小明","小英","大雄")

# 有多少位置可選：
length(vectorExample)   #顯示有幾個值，此例會跑出3
```

```{r}
vectorExample[[1]]
vectorExample[[3]]
```


```{r}
listExample <- 
  list(
    student="小明",
    `學期`=list(
      `108-1`=list(
        list(
          name="個體經濟學",
          teacher="Alice",
          grade=85
        )
      ),
      `108-2`=list(
        list(
          name="總體經濟學",
          teacher="Mark",
          grade=78
        )
      )
    )
  )
# 有多少位置可選：
length(listExample)
```

```{r}
listExample[[1]]
listExample[[2]]
```

```{r}
install.packages('curl')
```


```{r}
library(jsonlite)
fromJSON("https://data.tainan.gov.tw/dataset/4cd9345a-04bf-4328-a97d-314ff78b4763/resource/afc025fc-1ef4-447c-b785-a680391d0ca1/download/tnsport2.json", simplifyDataFrame = F) -> tainanSportsMap

length(tainanSportsMap)
```

```{r}
tainanSportsMap[[1]]
tainanSportsMap[[1076]]
```

#### 用名字選`$.`

```{r}
#有多少名字可選:
names(listExample)   #此例會跑出student和學期
```

```{r}
listExample$student
listExample$`學期` # 特殊命名依然要用反頓點呼叫
```

```{r}
str(listExample)
```

```{r}
str(listExample$`學期`)
```


其實也可以用[["名字"]]來選，只是名字要以字串「值」的方式來寫，也就是要用引號一對"…", 不用反頓點一對`…`。
```{r}
listExample[["student"]]
listExample$student

listExample[["學期"]] # 小心不是反頓點喔。
listExample$`學期`
```

```{r}
student <-"student"
listExample[[student]]
```


[新北市各區衛生所之門診時間及疫苗種類彙整表]
```{r}
fromJSON("http://data.ntpc.gov.tw/api/v1/rest/datastore/382000000A-000157-002",
         simplifyDataFrame = F) -> newTaipeiCityVaccine
```

```{r}
str(newTaipeiCityVaccine)
length(newTaipeiCityVaccine)
names(newTaipeiCityVaccine)
```

```{r}
str(newTaipeiCityVaccine[[1]])
str(newTaipeiCityVaccine$success)
str(newTaipeiCityVaccine[["success"]])

str(newTaipeiCityVaccine[[2]], max.level = 1)
str(newTaipeiCityVaccine$result, max.level = 1)
str(newTaipeiCityVaccine[["result"]], max.level = 1)
```

### 選「多個元素」

#### 用位置選`[c(...)]`

```{r}
vectorExample
vectorExample[c(1,3)]
vectorExample[c(3,2,1)] # 產生重新排列效果
```

```{r}
# 顯示到第一層
str(listExample, max.level=1)

str(listExample[c(1,2)], max.level = 1)
str(listExample[c(2,1)], max.level = 1)
```

任選數筆tainanSportsMap的運動地點。
```{r}
str(tainanSportsMap, max.level = 1)
str(tainanSportsMap[c(1,382,1076)], max.level = 1)
```

#### 用名字選`[c("name1","name2",...)]`{-}

```{r}
# 顯示到第一層
str(listExample, max.level=1)

listExample[["學期"]]   
listExample[c("student","學期")]
listExample[c("學期","student")]
```

臺北市夜市資料（來自臺北市食材登錄平台食材來源資訊）
```{r}
fromJSON("https://www.dropbox.com/s/qnm9bnz7vccrvcz/taipeiNightMarkets.json?dl=1", simplifyDataFrame = F) -> taipeiNightMarkets
```
任選幾個夜市元素出來。
```{r}
taipeiNightMarkets[c(1,3,5)]
taipeiNightMarkets[c("寧夏觀光夜市","廣州街觀光夜市","西昌街觀光夜市")]
```

```{r}
names(taipeiNightMarkets)
length(taipeiNightMarkets)
```

#### 用「要/不要」邏輯向量選`[c(T,T,F,...)]`{-}

```{r}
vectorExample
vectorExample[c(T,T,F)] # 要，要，不要
```

```{r}
str(listExample)
str(listExample[c(F,T)]) # 不要，要
str(listExample[c("學期")])    # 430和431是一樣的
str(listExample[c(T,T)]) # 要，要
```

用「要/不要」邏輯向量自taipeiNightMarkets選出 寧夏觀光夜市，西昌街觀光夜市，大龍街夜市， 雙城街夜市。
```{r}
names(taipeiNightMarkets)
```

```{r}
c(T,F,F,F,T,
  F,F,F,F,T,
  F,F,F,T) -> selectedMarkets
taipeiNightMarkets[selectedMarkets]

str(taipeiNightMarkets[c(T,F,F,F,T,
  F,F,F,F,T,
  F,F,F,T)], max.level = 1)
```

```{r}
selectedMarkets <- rep(F,14)  # repeat F by 14 times
print(selectedMarkets)
selectedMarkets[c(1,5,10,14)] <- TRUE  #replacement
print(selectedMarkets)
```

```{r}
str(taipeiNightMarkets[selectedMarkets], max.level = 1)
```



```{r}
str(listExample, max.level = 3)
```

```
listExample: length=2, list class
  |
  |--student: length=1, character class
  |
  |--學期: length=3, list class
```
以下兩個表面都是選取“學期”:
```{r}
get1 <- listExample[["學期"]]
get2 <- listExample["學期"]
```

*`[[]]`: 拿出某個物件值

```{r}
# get1 # 學期拿出來，有3個元素的list
str(listExample, max.level = 3)
```

```{r}
get1 <- listExample[["學期"]]
str(get1, max.level = 1)
```

*`[]`: 留下某個物件值

```{r}
# get1 # 學期拿出來，有3個元素的list
str(listExample, max.level = 3)
```

```{r}
get2 <- listExample["學期"] # listExample 只留下 學期元素，是個只有一個元素的list
str(get2, max.level = 1)
str(get2, max.level = 2)
```

差別比較看以下3個:
```{r}
str(listExample, max.level = 3)
```

```{r}
str(get1, max.level = 1)
```

```{r}
str(get2, max.level = 2)
```


### 連鎖選取


```{r}
numVector <- c(2,3,6,-1,4,2,6)
select1 <- numVector[c(1,4)]; select1  #就是2和-1
select2 <- select1[[1]]; select2  #就是2

# 相當於
numVector[c(1,4)][[1]]
```


```{r}
select1 <- numVector[c(T,T,F,T,F,F,T)]; select1
select2 <- select1[c(1,4)]; select2

# 相當於
numVector[c(T,T,F,T,F,F,T)][c(1,4)]
```


```{r}
majors <- c("經濟學系","經濟學系","社會學系","社工系","經濟學系")
names <- c("小英", "小美", "大雄","阿華", "阿尼")
gender <- c("F","F","M","F","M")

# 答案:
econOnly <- c(T,T,F,F,T)
names[econOnly]
gender[econOnly]
econFemaleOnly <- gender[econOnly][c(T,T,F)] 
names[econOnly][c(T,T,F)]
```
創造出只要“經濟學系”學生的邏輯向量，econOnly。
選出econOnly的names與gender。
在econOnly的gender下創造出只要“F”的邏輯向量, econFemaleOnly。
選出names中為“經濟學系”且“F”的姓名。



在前面討論使用[[ ]]（同$）及[ ]取一個元素時我們創造了get1與get2兩個物件，請分別由get1, get2取出108-1學期個體經濟學教師姓名。
```{r}
get1 <- listExample[["學期"]] #拿出來
get2 <- listExample["學期"] #只留下

names(get1)
names(get2)
```

```{r}
str(get1)
```

```{r}
str(get2)
```

練習答案:
自己寫:
```{r}
get1$`108-1`[[1]][[2]]
get2$`學期`[[1]][[1]][[2]]
```
老師寫:
```{r}
listExample[["學期"]]$`108-1`[[1]]$teacher
listExample["學期"][[1]][["108-1"]][[1]]$teacher
```


```{r}
get1 <- listExample[["學期"]] #拿出來
get2 <- listExample["學期"] #只留下
```


## list應用

*atomic vector不能用＄取元素 但list可以
```{r}
vector1 <- c(a=1,b=3,c=4)
vector1[["a"]]
vector1[c("a","c")]
vector1$a #不能用

list1 <- list(a=1,b=3,c=4)
list1[["a"]]
list1[c("a","c")]
list1$a
```


```{r}
today <- list(
  list("台北市",
       highest_temp=c(highest_temp = 25), #atomic vector也可以命名
       lowest_temp=c(lowest_temp = 18)),
  list("新北市",
       highest_temp=c(highest_temp = 24),
       lowest_temp=c(lowest_temp = 15)))

str(today)
```
```{r}
today[[1]]$highest_temp  #為何繼續保留vector裡的highest_temp?因為選取並執行後會顯示highest_temp和25
```


```{r}
tomorrow <- list(
  list("台北市", c(highest_temp = 25),c(lowest_temp = 18)),
  list("新北市",c(highest_temp = 24),c(lowest_temp = 15)))
  

weather <- list(today,tomorrow)

print(weather)
```


## 新增/替換/刪除元素

**範例**
```{r}
a <- c("1","b","TRUE")
a
a[[2]] <- "c" # 元素存在: 替換
a[[4]] <- "7" # 元素不存在： 增加
a[c(5,6)] <- c("J", "K")
a
```

```{r}
a[[7]] <- "Johnson"  #增加一個“Johnson”
a

a <- c(a,"Mary")  #使用前一章的向量疊代(recursive vector concatenate)法，新增一個“Mary”
a
```


```{r}
library(lubridate)
list1 <- 
  list(
    list(
      name="Jack",
      birthday=ymd("1998-03-21"),
      status=c(height=177, weight=80)
    )
  )

str(list1)
```

```{r}
# 更改日期
list1[[1]]$birthday <- ymd("1997-03-21")

# 新增資料
list1[[2]] <- list(
  name="Mary",
  birthday=ymd("1998-08-24")
)

str(list1)
```

練習:
1.替Mary依Jack的記錄方式增加身高163，體重45。
2.將Jack的身高改成176。
```{r}
list1[[2]]$status <- c(height=163, weight=45)
list1[[1]]$status <- c(height=176, weight=80) #list1[[1]]$status[["height"]] <- 176  也可以
str(list1)
```


使用[.] <-

由於[.]會保留母層結構，所以<-右側要使用和母層相同的型態設定：

母層若為list，則需用list(...)方式增加。

母層若為atomic vector，則用c(...)方式增加。
```{r}
list1[[1]][["age"]] <- 21
list1[[2]]["age"] <- list(21)  #["age"]保留了母層的list

# 改變「一個」時，使用[[ ]]比較不會錯。
str(list1)
```

```{r}
list1[[1]][c("bloodType","registered")] <- list("AB",TRUE) #新增"bloodType","registered"

str(list1)
```




```{r}
listExample <- 
  list(
    student="小明",
    `學期`=list(
      `108-1`=list(
        list(
          name="個體經濟學",
          teacher="Alice",
          grade=85
        )
      ),
      `108-2`=list(
        list(
          name="總體經濟學",
          teacher="Mark",
          grade=78
        )
      )
    )
  )
# 有多少位置可選：
length(listExample)
```
進行以下任務：

1.108-1新增一個“產業經濟學”。

2.產業經濟學，同時加上教師Wen及成績88。

答案:
```{r}
listExample$`學期`$`108-1`[[2]] <- 
  list(
    name="產業經濟學"
  )
str(listExample)
```

```{r}
listExample$`學期`$`108-1`[[2]][c("teacher","grade")] <- list("Wen",88)
str(listExample)
```



刪除可以使用`[- c(數字位置)]`
 只能「一個」中括號（[[.]]不能接受負數值）
 只能用負數值，不能用元素名稱。
```{r}
print(a)
a[-c(1,3)]  #刪除1和TRUE
a[c(-2)]    #刪除c

print(a)
a[-c(1,3)] -> a # 要回存才算真的刪除
```



```{r}
library(lubridate)
list1 <- 
  list(
    list(
      name="Jack",
      birthday=ymd("1998-03-21"),
      status=c(height=177, weight=80)
    ),
    list(
      name="Mary",
      birthday=ymd("1998-08-24"),
      status=c(height=163, weight=45),
      age=21,
      bloodType="AB"
    )
  )
str(list1)
```
自先前List1範例
1.刪除Jack的status.
```{r}
list1[[1]][-c(3)] -> list1[[1]] #記得回存，而且要小心不要寫成list1，要寫list1[[1]]，不然會整個取代掉             #也可以直接寫[-3]
str(list1)
```

2.刪除Mary的status, bloodType.
```{r}
list1[[2]][-c(3,5)] -> list1[[2]]
str(list1)
```


list元素要刪除時也可以用[.]<-NULL, [[.]]<-NULL, $.<-NULL
```{r}
str(list1)
list1[[2]][c(1,2)] <- NULL  #好處是"不用回存"
#list1[[2]][-c(1,2)] -> list1[[2]] "要回存"
str(list1)
```



以下資料來自 新北市公共自行車租賃系統(YouBike)
```{r}
library(jsonlite)
fromJSON("https://data.ntpc.gov.tw/od/data/api/54DDDC93-589C-4858-9C95-18B2046CC1FC?$format=json", simplifyDataFrame = F) -> newTaipeiYouBike
```
請自行對它做內容更動練習。
```{r}
#刪除汐止火車站
#方法一
newTaipeiYouBike[[2]][-c(2)] -> newTaipeiYouBike[[2]]
str(newTaipeiYouBike)
#方法二
newTaipeiYouBike[[2]][[2]] <- NULL
str(newTaipeiYouBike)
```


## On numeric class


加、減、乘、除： +, -, *, /
```{r}
a <- c(2, 3, 5)
b <- c(4,-1, 3)
```

```{r}
a+b
a-b
a*b
a/b
```

餘數：` %% `

次方：`**`或 `^`
```{r}
a %% b
a ** b
```


### 奇、偶數判斷
```{r}
sequenceNums <- c(11, 6, 8, 11, 12, 11, 3, 7, 10, 8)
print(sequenceNums)

sequenceNums %% 2 # 餘數為1則是奇數，0則是偶數
```


***

在多數時候R向量間的運算都是**elementwise**(個別元素)的運算：

 * 所有向量一一取出各自對應相同位置的元素值進行運算。

```{r}
# a+b 即等於
c(2+4, 3+(-1), 5+3)
# a**b 即等於
c(2**4, 3**(-1), 5**3)
```


當向量間不等長度時，R則對短的向量進行Recycle的動作（即Python的Broadcast）:

將其中較短的向量**反複堆疊到可以長得跟最長的向量一樣長度**。

```{r}
5*c(1,3,4)+7
# 其實是
c(5)*c(1,3,4)+c(7)

## 對向量5，向量7進行recycle:
c(5,5,5)*c(1,3,4)+c(7,7,7)
## Recycle等長後才進行elementwise operation:
c(5*1+7, 5*3+7, 5*4+7)
```


當運算的兩物件內容長度不同時，則將其中較短的一個**反複堆疊到可以長得跟另一個一樣高**時才來運算，稱為recycling。

```{r}
# 狀況一: 堆疊一定倍數剛好一樣長
c(2,3)/c(-2,-13,10,22)
c(2,3,2,3)/c(-2,-13,10,22)
```

```{r}
# 狀況二: 倍數堆疊一定會超過，只好截斷
c(2,3)/c(-2,-13,10)
c(2,3,2)/c(-2,-13,10)
```


Recycling不只用在數值class, 只要向量間的處理要等長度才合理時，recycling通常也會用在其他的class。

```{r}
paste0(
  c("我叫"), c("小明","小美")
)
```
也等於是
```{r}
paste0(
  c("我叫","我叫"), c("小明","小美")
)
```



```{r}
paste0(
  c("他叫","我叫"), c("小明","小美","大雄")
)
```
會出現什麼？


## Relational Operators

這節在介紹產生「要/不要」向量的常見手法。

```{r}
example <- list(
  name=c("小明","小花","小新","美美"),
  height=c(175,166,170,160),
  weight=c(77,NA,60,43),
  birthday=lubridate::ymd(c("1998-03-11","1999-12-22","1995-08-22","2001-10-10")),
  hobby=c("美食 旅遊","旅遊 時尚","3C 美食","音樂 旅遊"),
  residence=c("Taipei","New Taipei","Taichung","Kaohsiung"),
  allowance=factor(c("0-1000","1001-2000","2000+","1001-2000")),
  bloodType=c("A","B","B","O")
)
```


### 比較

`>`,`<`,`<=`,`>=`: 分別為大於、小於、小於等於、大於等於

 * 數字比較

 * 時間比較

 * 可排序類別資料比較

##### 數字比較

example裡誰的身高大於等於170

```{r}
str(example[c("name","height")])

pick_above170 <- example$height >= 170
example$name[pick_above170]
```


不同屆入學學生在2年級的學業表現

```{r}
source("https://www.dropbox.com/s/qsrw069n94k61lj/transcript100to103_list.R?dl=1")
```

```{r}
str(transcript100to103)
```

分析情境：
```{r}
# 各學屆2年級人數
table(transcript100to103$`學屆`)
# 各學屆2年級成績大於85年數
table(transcript100to103$`學屆`[pick_above85])
```


選成績大於85分
```{r}
# 只要成績大於85的
pick_above85 <-
  transcript100to103$`成績` > 85
```

```{r}
# 各學屆2年級人數
table(transcript100to103$`學屆`)
# 各學屆2年級成績大於85人數
table(transcript100to103$`學屆`[pick_above85])
```


##### 時間比較:

example裡誰1998年(含)以後出生
```{r}
print(example[c("name","birthday")])

pick_after98 <- example$birthday >= lubridate::ymd("1998-01-01")
example$name[pick_after98]
```


美元匯率
```{r}
source("https://www.dropbox.com/s/16h6ggua6qtydci/exchangeRate.R?dl=1")
```

```{r}
str(exchangeRate)
```


情境
```{r}
exchangeRate_after98 <-
  list(
    `期間`=exchangeRate$`期間`[pick_after98_01],
    `幣別`=exchangeRate$`幣別`[pick_after98_01],
    `匯率`=exchangeRate$`匯率`[pick_after98_01]
    
  )
```

選1998年1月(含)以後的匯率
```{r}
# 只要1998年1月（含）以後的
library(lubridate)
pick_after98_01 <-
  exchangeRate$`期間` >= ymd("1998-01-01")
```
選出1998年1月(含)以後的匯率資料
```{r}
exchangeRate_after98 <-
  list(
    `期間`=exchangeRate$`期間`[pick_after98_01],
    `幣別`=exchangeRate$`幣別`[pick_after98_01],
    `匯率`=exchangeRate$`匯率`[pick_after98_01]
  )
```


#### 可排序類別資料比較:

example裡誰零用錢大於1000:

```{r}
print(example[c("name","allowance")])

pick_allowanceOver1000 <- example$allowance >= "1001-2000"
example$name[pick_allowanceOver1000]
```


factor資料可進一步分成可排序，與不可排序的，如：
* 可排序： 以年齡層區分的類別，以所得級距區分的類別等。
* 不排序： 性別，學系等。

factor的設定在不調整時內定為不可排序資料，如要改成可排序類別資料，以先前已處理好的example$allowance 為例：

```{r}
levels(example$allowance)
```

```{r}
class(example$allowance)  #最後看一下class發現他多了ordered
```


```{r}
example$allowance <- 
  ordered(example$allowance)    #先看levels，如果順序沒錯，就可使用ordered告訴電腦是由小到大。
                                #變成可排序資料，然後回存到他自己。
```

或在設定為factor時即把levels排好，並`ordered=T`:
```{r}
example$allowance <-
  factor(
    example$allowance,
    levels=c("0-1000", "1001-2000", "2000+"),
    ordered = T # 設定為可排序factor
  )
```

```{r}
pick_allowanceOver1000 <- example$allowance >= "1001-2000"
example$name[pick_allowanceOver1000]
```


刑事案件被害者人數

```{r}
jsonlite::fromJSON("https://www.dropbox.com/s/3uijub7xheib405/list_victimAges_female.json?dl=1", simplifyDataFrame = F) -> list_victimAges_female
```

請將list_victimAges_female各元素的class做合理設定。
```{r}
levels(list_victimAges_female$`年齡層`) -> levels_ages
print(levels_ages)
```
參考解答:
```{r}
list_victimAges_female$`數目` <-
  as.integer(list_victimAges_female$`數目`)
list_victimAges_female$`年齡層` <- 
  as.factor(list_victimAges_female$`年齡層`)
```


將levels順序改成: 不詳，總計，0_5歲，12_17歲，…，70歲以上。
參考解答:
```{r}
levels_new <- c(levels_ages[c(12,13,1,8,2:7,9:11)])
levels(list_victimAges_female$`年齡層`) <- levels_new
```



情境:
```{r}
sum(list_victimAges_female$`數目`, na.rm=T)
sum(list_victimAges_female$`數目`[pick_above30], na.rm = T)
```

可選出「30_39歲以上受害者」的「要/不要」向量：
```{r}
pick_above30 <- 
  list_victimAges_female$`年齡層` >= "30_39歲"
```

選出「30_39歲以上受害者」的數目
```{r}
sum(list_victimAges_female$`數目`, na.rm=T)
sum(list_victimAges_female$`數目`[pick_above30], na.rm = T)
```


### 相等，屬於

`==`: 等於

`!=`: 不等於

`==`與`!=`可使用於字串

example裡誰血型B型

```{r}
print(example[c("name","bloodType")])

pick_bloodB <- example$bloodType == "B"
example$name[pick_bloodB]
```


```{r}
sequenceNums <- c(11, 6, 8, 11, 12, 11, 3, 7, 10, 8)

pick_evens <- (sequenceNums %% 2) == 0
sequenceNums[pick_evens]
```
創造可留下偶數的「要/不要」向量pick_evens。



***

還有一個常用的關聯運算：

`%in%`: 屬於

 * 左邊元素「一一」檢視是不是屬於右邊元素集合。
 
```{r}
x <- c(1,5,8)
y <- c(5,8)

# x裡的元素值是不是屬於y集合
x %in% y
```


example裡誰來自大台北
```{r}
print(example[c("name","residence")])

set_TaipeiMetro <- c("Taipei","New Taipei")
pick_fromTaipeiMetro <- example$residence %in% set_TaipeiMetro
example$name[pick_fromTaipeiMetro]
```



創造 可選出來自法商學院的「要/不要」向量，pick_lawBusiness。
```{r}
source("https://www.dropbox.com/s/qsrw069n94k61lj/transcript100to103_list.R?dl=1")
```

```{r}
str(transcript100to103)
```
練習:
```{r}
levels(factor(transcript100to103$`學院`))   #可以先檢查一下名稱，法學院有可能會寫成法律學院

unique(transcript100to103$`學院`)   #使用unique重複的就不會再顯示
```


```{r}
set_lawBusiness <- c("法學院", "商學院")
pick_lawBusiness <- transcript100to103$`學院` %in% set_lawBusiness
```



### Negation(否定用法)

在「要/不要」向量前加上!會成為否定句的「要/不要」向量，元素裡的TRUE會轉成FALSE, FALSE則轉成TRUE。

```{r}
pick_not_fromTaipeiMetro <- ! pick_fromTaipeiMetro
# 或
pick_not_fromTaipeiMetro <- !(example$residence %in% set_TaipeiMetro) # (..) 裡面會先運算完才做外面!的處理
```


```{r}
print(example[c("name","residence")])

example$name[pick_fromTaipeiMetro]
example$name[pick_not_fromTaipeiMetro]
```



### 資料狀態

 * is.na: 有缺失

 * is.{class/type name}: is.integer, is.character, is.factor … etc

有時資料有缺失，在R裡會記成NA(即not available)如下例：

```{r}
x2 <- c(1,NA,10)
y2 <- c(-1,NA,20)

x3 <- c(NA,"小花")
y3 <- c(NA,"小華")
```

前述的關係判斷遇到NA時，結果都會是NA——即無法判斷。要知道向量內各元素值是否NA，可使用is.na():

```{r}
x2
is.na(x2)
```


example裡誰沒有體重資料
```{r}
print(example[c("name","weight")])

pick_na <- is.na(example$weight)
example$name[pick_na]
```

R還有一種特別的缺失資料NaN (即not a number)，出現在沒有定義的數學運算上，如：
```{r}
0/0
```



```{r}
list_victimAges_female$`數目` <- as.integer(list_victimAges_female$`數目`)
```
創立 可選出缺失資料的「要/不要」向量pick_na, 並計算有多少筆缺失。
```{r}
pick_na <- is.na(list_victimAges_female$`數目`)
total_na <- sum(pick_na)
print(total_na)
```


### 字元偵測

 * stringr::str_detect()
 
 example裡誰喜歡美食
```{r}
print(example[c("name","hobby")])

pick_loveFood <- stringr::str_detect(example$hobby,"美食")
example$name[pick_loveFood]
```
 
注意!
`== `字串內容一模一樣。

`str_detect`字串內容有關鍵字。
別犯以下錯誤:
```{r}
pick_loveFood <- example$hobby == "美食"
```




以下資料為新北市垃圾車路線
```{r}
jsonlite::fromJSON("https://data.ntpc.gov.tw/od/data/api/EDC3AD26-8AE7-4916-A00B-BC6048D19BF8?$format=json") ->
  garbageRoutes
```


```{r}
#  1 用typeof()函數查詢電腦實質上如何看待garbageRoutes。
typeof(garbageRoutes)  
#  2 用class()函數查詢電腦把它能進行的操作運算歸屬於哪一類型。
class(garbageRoutes)
```

由於garbageRoutes的本質是list，所以我們可以使用list所有操作手法，而class為data frame表示它有比典型list的運作多了些工具與變化（後面章節會提）。


```{r}
# 由linename元素判斷垃圾車有幾條路線。
factor(garbageRoutes$linename) -> garbageRoutes$linename
levels(garbageRoutes$linename)
  
# 由linename創造： 可篩選出下午路線的「要/不要」向量pick_afternoonRoutes。
```


```{r}
pick_afternoonRoutes <-
  stringr::str_detect(
    garbageRoutes$linename,
    "下午"
  )

garbageRoutes$linename[pick_afternoonRoutes]
```


### 閱讀函數說明

```{r}
?str_detect
```

 * Title, Description, Usage, Arguments, Value, Examples
 * 看電子書

***

疾病管制署傳染病答問集

```{r}
CDC_chatbox <- readr::read_csv("http://od.cdc.gov.tw/pr/CDC_chatbox.csv")
```
找出問題中包含“肺炎”字眼的問題。
練習答案:
```{r}
pick_pneumonia <- stringr::str_detect(CDC_chatbox$Question, "肺炎")
CDC_chatbox$Question[pick_pneumonia]
```





